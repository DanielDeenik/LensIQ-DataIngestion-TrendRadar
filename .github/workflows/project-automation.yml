name: Project Automation

on:
  issues:
    types: [opened, closed, reopened, labeled]
  pull_request:
    types: [opened, closed, reopened, ready_for_review]

jobs:
  add-to-project:
    name: Add issue or PR to project
    runs-on: ubuntu-latest
    steps:
      - name: Add to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/DanielDeenik/projects/4
          github-token: ${{ secrets.GITHUB_TOKEN }}

  auto-assign-labels:
    name: Auto-assign module labels
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check module in issue body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Module mapping
            const modules = {
              'TrendRadar': 'module:trendradar',
              'Storytelling': 'module:storytelling',
              'Strategy Hub': 'module:strategy',
              'VC Lens': 'module:vc-lens',
              'Graph Analytics': 'module:graph',
              'Data Management': 'module:data',
              'Lookthrough': 'module:lookthrough',
              'Lifecycle': 'module:lifecycle',
              'AI Copilot': 'module:copilot',
              'Platform/Infrastructure': 'module:platform'
            };
            
            // Check which modules are mentioned
            const labels = [];
            for (const [module, label] of Object.entries(modules)) {
              if (body.includes(`[x] ${module}`) || body.includes(`[X] ${module}`)) {
                labels.push(label);
              }
            }
            
            // Add priority labels
            if (body.includes('[x] Critical') || body.includes('[X] Critical')) {
              labels.push('priority:critical');
            } else if (body.includes('[x] High') || body.includes('[X] High')) {
              labels.push('priority:high');
            } else if (body.includes('[x] Medium') || body.includes('[X] Medium')) {
              labels.push('priority:medium');
            } else if (body.includes('[x] Low') || body.includes('[X] Low')) {
              labels.push('priority:low');
            }
            
            // Add labels if any were found
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  notify-on-critical:
    name: Notify on critical issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'priority:critical'
    steps:
      - name: Comment on critical issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸš¨ This issue has been marked as **CRITICAL**. It will be prioritized for immediate attention.'
            });

